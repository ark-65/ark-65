import os, re, json, hashlib, html
from datetime import datetime, timezone

try:
    from zoneinfo import ZoneInfo
except Exception:
    ZoneInfo = None

from urllib import request, parse

SIGNS = [
    ('aries', 'ç™½ç¾Šåº§', 'â™ˆ'), ('taurus', 'é‡‘ç‰›åº§', 'â™‰'), ('gemini', 'åŒå­åº§', 'â™Š'),
    ('cancer', 'å·¨èŸ¹åº§', 'â™‹'), ('leo', 'ç‹®å­åº§', 'â™Œ'), ('virgo', 'å¤„å¥³åº§', 'â™'),
    ('libra', 'å¤©ç§¤åº§', 'â™'), ('scorpio', 'å¤©èåº§', 'â™'), ('sagittarius', 'å°„æ‰‹åº§', 'â™'),
    ('capricorn', 'æ‘©ç¾¯åº§', 'â™‘'), ('aquarius', 'æ°´ç“¶åº§', 'â™’'), ('pisces', 'åŒé±¼åº§', 'â™“')
]

TIP_BUCKET = [
    'æŠŠæ³¨æ„åŠ›æ”¾åœ¨é‡è¦çš„äººå’Œäº‹ä¸Š', 'è¯•ç€æ—©ç¡æ—©èµ·ï¼Œæ•ˆç‡æ›´é«˜', 'å¤§èƒ†ä¸€ç‚¹ï¼Œä¼šæœ‰æƒŠå–œå‘ç”Ÿ', 'åˆ«æ€¥äºæ±‚æˆï¼Œç¨³æ‰ç¨³æ‰“',
    'é€‚åˆæ•´ç†æ”¶çº³ä¸å¤ç›˜æ€è€ƒ', 'å¤šå€¾å¬ï¼Œå°‘äº‰è¾©ï¼Œäº‹åŠåŠŸå€', 'å…‹åˆ¶æƒ…ç»ªï¼Œä¿æŒè€å¿ƒ', 'å°è¯•åšä¸€ç‚¹è¿åŠ¨ï¼Œç„•æ–°çŠ¶æ€',
    'ä»Šæ—¥é€‚åˆå­¦ä¹ å’Œå¸æ”¶æ–°çŸ¥', 'ç»™è‡ªå·±ä¸€ä¸ªå°ç›®æ ‡å¹¶å®Œæˆå®ƒ', 'ä¸è€æœ‹å‹è”ç»œä¼šå¸¦æ¥å¥½è¿', 'å°‘åˆ·æ‰‹æœºï¼Œä¸“æ³¨å½“ä¸‹',
    'ä¸»åŠ¨è¡¨è¾¾æƒ³æ³•ï¼Œæœ‰äººä¼šå“åº”', 'é¿å…å†²åŠ¨æ¶ˆè´¹ï¼Œç†æ€§ä¸€ç‚¹', 'æŠŠå¤æ‚é—®é¢˜æ‹†è§£æˆå°æ­¥', 'åšä¸ªå°å°çš„å–„ä¸¾ï¼Œè¿åŠ¿+1',
    'æ¸…æ™°è¾¹ç•Œï¼Œæ‹’ç»æ— æ•ˆå†…è€—', 'è®°å½•çµæ„Ÿï¼Œç«‹åˆ»è¡ŒåŠ¨ä¸€ä¸ª', 'ä¿æŒå¥½å¥‡ï¼Œå‘é—®ä¸æ¢ç´¢', 'æ‹¥æŠ±å˜åŒ–ï¼Œç›¸ä¿¡ç›´è§‰',
    'ä»Šå¤©é€‚åˆå¼€å§‹æ–°è®¡åˆ’', 'å¤ç›˜æœ€è¿‘ä¸€å‘¨çš„æ”¶è·', 'æŠŠå¾…åŠæ¸…å•ç²¾ç®€åˆ°ä¸‰ä»¶', 'å°è¯•ç•ªèŒ„å·¥ä½œæ³•',
    'å’Œå®¶äººå¥½å¥½åƒé¡¿é¥­', 'æ•´ç†é‚®ä»¶ä¸æ¶ˆæ¯æ”¶ä»¶ç®±', 'é¼“åŠ±èº«è¾¹çš„äººï¼Œä¹Ÿé¼“åŠ±è‡ªå·±', 'å­¦ä¸€ç‚¹å¾®å°çš„æ–°æŠ€èƒ½',
    'å‡å°‘æŠ±æ€¨ï¼Œå¤šåšä¸€ç‚¹', 'ç»™æœªæ¥çš„è‡ªå·±å†™ä¸€å°ä¿¡', 'å–è¶³å¤Ÿçš„æ°´ï¼Œä¿æŒæ¸…é†’', 'ç«™èµ·æ¥ä¼¸å±• 5 åˆ†é’Ÿ',
    'ä¸è¦æ‹–å»¶ï¼Œä»æœ€éš¾çš„å¼€å§‹', 'å®Œæˆä¸€ä»¶é•¿æœŸå›é¿çš„å°äº‹', 'å¬ä¸€é¦–è®©ä½ æŒ¯å¥‹çš„æ­Œ', 'é˜…è¯» 10 é¡µä¹¦',
    'ç»™åŒäº‹æˆ–æœ‹å‹ä¸€å¥æ„Ÿè°¢', 'ä¼˜åŒ–ä¸€ä¸ªé‡å¤æµç¨‹', 'å‡å°‘æ— æ„ä¹‰çš„å¯¹æ¯”', 'æ¥å—ä¸å®Œç¾ï¼Œç»§ç»­å‰è¿›',
    'ç”¨æ•°æ®è¯´è¯ï¼Œç”¨äº‹å®å†³ç­–', 'ä¿æŒå­¦ä¹ èŠ‚å¥ï¼Œç¨³æ­¥ç§¯ç´¯', 'æŠŠæ‰‹æœºé™éŸ³ 30 åˆ†é’Ÿ', 'æ³¨æ„ç”¨çœ¼å¥åº·',
    'ä»Šå¤©æ—©ç‚¹ç»“æŸå·¥ä½œ', 'è®¾å®šè¾¹ç•Œï¼Œæ‹’ç»é¢å¤–è´Ÿæ‹…', 'å¤ä¹ æ—§ç¬”è®°ï¼Œæ¸©æ•…çŸ¥æ–°', 'åˆ—å‡ºä¸‰ä»¶å€¼å¾—æ„Ÿæ©çš„äº‹',
    'ä¿æŒä¸“æ³¨ï¼Œå‡å°‘ä¸Šä¸‹æ–‡åˆ‡æ¢', 'å¯¹é‡è¦ä»»åŠ¡è®¾ç½®æ—¶é—´å—', 'æå‰å‡†å¤‡æ˜å¤©çš„å¾…åŠ', 'æ¸…ç†æ¡Œé¢ï¼Œé‡å¯çŠ¶æ€',
    'ç•™å‡ºç‹¬å¤„çš„æ—¶é—´', 'æŠŠæƒ³æ³•ç”»æˆè‰å›¾', 'è¿›è¡Œä¸€æ¬¡æ€ç»´å¯¼å›¾', 'å…³æ³¨é•¿æœŸä»·å€¼è€ŒéçŸ­æœŸå™ªéŸ³',
    'å†™ä¸‹ä»Šå¤©æœ€å¼€å¿ƒçš„ç¬é—´', 'å›é¡¾ç›®æ ‡ä¸è¿›åº¦', 'å’Œå¿—åŒé“åˆçš„äººäº¤æµ', 'ä¿æŒè€å¿ƒï¼Œç­‰å¾…å‘èŠ½',
    'ä»Šå¤©é€‚åˆåšå‡æ³•', 'æŠŠæµç¨‹æ ‡å‡†åŒ–å¹¶è®°å½•', 'åˆ†æ¸…ç´§æ€¥ä¸é‡è¦', 'ä¸“æ³¨è¿‡ç¨‹ï¼Œä¸æ‰§ç€ç»“æœ',
    'ç»™è‡ªå·±ä¸€ç‚¹å¥–åŠ±', 'æŠŠé—®é¢˜æ¢ä¸ªè§’åº¦çœ‹', 'ä»é”™è¯¯ä¸­æå–ç»éªŒ', 'å°è¯•åšä¸€ä¸ªå°å®éªŒ',
    'æŠŠçŸ¥è¯†è¾“å‡ºæˆä¸€æ®µç¬”è®°', 'ä¼˜åŒ–ä¸€æ¬¡é‡å¤æ€§çš„ä»»åŠ¡', 'æå‰ååˆ†é’Ÿå‡ºå‘', 'ä¸»åŠ¨è¯·æ±‚åé¦ˆ',
    'æŠŠå¤æ‚äº‹æ‹†æˆæ¸…æ™°æ¸…å•', 'è¯•è¯•æ™¨é—´æˆ–æ™šé—´ä¾‹ä¼š', 'æŠŠèƒ½ä¸¤åˆ†é’Ÿå®Œæˆçš„äº‹ç«‹åˆ»åš', 'ä»Šå¤©æ¸©æŸ”åœ°å¯¹è‡ªå·±',
    'å‡å°‘ç³–åˆ†ä¸ç†¬å¤œ', 'é€‚å½“åˆä¼‘ï¼Œæ¢å¤ç²¾åŠ›', 'ä¸å’Œè¿‡å»è¾ƒåŠ²ï¼Œå‘å‰çœ‹', 'ç”¨æ¸…å•å¯è§†åŒ–è¿›å±•',
    'ä¸å…¶æ‹…å¿ƒä¸å¦‚è¡ŒåŠ¨', 'æƒ³ä¸€æƒ³â€œçœŸæ­£é‡è¦çš„æ˜¯ä»€ä¹ˆâ€', 'æŠŠæ‰¿è¯ºå†™ä¸‹æ¥', 'ç»™è‡ªå·±ä¸€ç‚¹å®‰é™',
    'æ‹¥æŠ±éšæœºæ€§ä¸å°æƒŠå–œ', 'ä¸»åŠ¨æå‡ºä¸€ä¸ªæ”¹è¿›å»ºè®®', 'å¤‡ä»½é‡è¦èµ„æ–™', 'å­¦ä¼šè¯´â€œä¸â€ä¹Ÿè¯´â€œå¥½â€',
    'å…³æ³¨å¥åº·ï¼Œé€‚é‡è¿åŠ¨', 'å­¦ä¹ ä¸€ä¸ªé”®ç›˜å¿«æ·é”®', 'æ‰“ç£¨ä¸€ä¸ªå°ä½œå“', 'æŠŠç›®æ ‡è¯´ç»™é è°±çš„äººå¬',
    'ç”¨é—®é¢˜å¼•å¯¼æ€è€ƒ', 'å¤ç›˜ä¸€æ¬¡æ²Ÿé€šæ˜¯å¦æ¸…æ™°', 'è¡¨è¾¾æ¸…æ¥šè¾¹ç•Œä¸é¢„æœŸ', 'å°è¯•å†¥æƒ³ä¸‰åˆ†é’Ÿ',
    'ä»Šå¤©é€‚åˆæ•´ç†è´¦ç›®', 'ç†æ€§çœ‹å¾…å¾—å¤±', 'å¯åŠ¨è€Œéç­‰å¾…å®Œç¾', 'é€‰æ‹©æœ€å°å¯è¡Œæ­¥éª¤',
    'æ„Ÿè°¢å½“ä¸‹ï¼Œçæƒœçœ¼å‰äºº', 'ä¿æŒä¸“ä¸šä¸å–„æ„', 'æŠŠä»»åŠ¡æ’ä¼˜å…ˆçº§', 'åˆ æ‰ä¸€ä¸ªæ— æ•ˆè®¢é˜…',
    'ä¸“æ³¨å½“ä¸‹çš„ä¸€å°æ­¥', 'å¯¹è‡ªå·±å®½å®¹ï¼Œå¯¹ç›®æ ‡åšå®š', 'ç”¨çµæ´»æ›¿ä»£åƒµåŒ–', 'åˆ«æ€•æ±‚åŠ©ï¼Œåä½œæ›´å¼º',
    'ä¿æŒä¿¡æ¯æ•´æ´ï¼Œå‡å°‘å™ªéŸ³', 'ä»Šå¤©å¯¹è‡ªå·±è¯´â€œå¹²å¾—å¥½â€', 'é¿å…è¿‡åº¦æ‰¿è¯º', 'ç”¨å¿ƒå€¾å¬çœŸå®éœ€æ±‚',
    'æ‹†æ‰å¿ƒç†å¢™ï¼Œè¿ˆå‡ºä¸€æ­¥', 'å–„å¾…èº«ä½“ï¼Œæ—©ç¡æ—©èµ·', 'ç»ƒä¹ æ¸…æ™°è¡¨è¾¾', 'è®©ç¯å¢ƒä¸ºä½ æœåŠ¡',
    'åšä¸ªé è°±çš„äººï¼ŒæŒ‰æ—¶äº¤ä»˜', 'ç»™å‡ºå…·ä½“ä¸”å¯æ‰§è¡Œçš„å»ºè®®', 'è¿½è¸ªä¸€æ¬¡å¾®å°çš„è¿›æ­¥', 'å®Œæˆæ¯”å®Œç¾æ›´é‡è¦',
    'ä¿æŒè°¦é€Šä¸é”‹èŠ’', 'æ…¢å°±æ˜¯ç¨³ï¼Œç¨³å°±æ˜¯å¿«', 'ä¸€æ¬¡åªåšä¸€ä»¶äº‹', 'æŠŠç›®æ ‡å†™åœ¨æ˜¾çœ¼å¤„',
    'å‡å°‘å†…è€—ï¼Œä¿æŠ¤ä¸“æ³¨åŠ›', 'ç”¨å¤ç›˜å–ä»£æ‡Šæ‚”', 'ä¸»åŠ¨å»ºç«‹æ­£å‘å¾ªç¯', 'ä¿æŒèŠ‚å¥ï¼Œä¸æ€¥ä¸å¾'
]

def fallback_tip(sign_idx: int, day_of_year: int) -> str:
    # çº¿æ€§è½®æ¢ï¼šç¡®ä¿è¿ç»­ 7 å¤©ä¸é‡å¤ï¼ˆTIP_BUCKET é•¿åº¦ >= 7ï¼‰
    idx = (day_of_year + sign_idx * 7) % len(TIP_BUCKET)
    return TIP_BUCKET[idx]

def fetch_tip(sign_en: str, sign_idx: int, day_of_year: int):
    url = f"https://aztro.sameerkumar.website/?sign={parse.quote(sign_en)}&day=today"
    try:
        req = request.Request(url, method='POST', data=b'')
        with request.urlopen(req, timeout=15) as resp:
            data = json.loads(resp.read().decode('utf-8'))
        desc = (data.get('description') or '').strip()
        if not desc:
            raise ValueError('empty description')
        tip = desc.split('.') [0].split('ã€‚')[0].strip()
        tip = (tip[:80] + 'â€¦') if len(tip) > 80 else tip
        return tip
    except Exception:
        return fallback_tip(sign_idx, day_of_year)

def build_section():
    tz = os.getenv('HORO_TZ', '').strip() or 'Asia/Shanghai'
    tzname = tz
    try:
        z = ZoneInfo(tzname) if ZoneInfo else None
    except Exception:
        z = None
    now_dt = datetime.now(z if z else timezone.utc)
    date_str = now_dt.strftime('%Y-%m-%d')
    date_key = now_dt.strftime('%Y%m%d')

    lines = []
    title = f"ğŸ”® Daily Horoscope Tips â€¢ {date_str} ({tzname})"
    lines.append(f"<p align=\"center\">")
    lines.append(f"<strong>{html.escape(title)}</strong><br/>")
    day_of_year = now_dt.timetuple().tm_yday
    for i, (en, zh, sym) in enumerate(SIGNS):
        tip = fetch_tip(en, i, day_of_year)
        item = f"{sym} {zh} {en.title()}: {tip}"
        lines.append(f"{html.escape(item)}<br/>")
    # ä»Šæ—¥å¹¸è¿æ˜Ÿåº§ï¼ˆæŒ‰å¤©è½®æ¢ï¼Œç¨³å®šä¸”æ¯å¤©ä¸åŒï¼‰
    lucky_idx = day_of_year % len(SIGNS)
    l_en, l_zh, l_sym = SIGNS[lucky_idx]
    lucky_line = f"âœ¨ ä»Šæ—¥å¹¸è¿æ˜Ÿåº§ï¼š{l_sym} {l_zh} {l_en.title()}"
    lines.append(f"<br/>{html.escape(lucky_line)}")
    lines.append("</p>")
    return "\n".join(lines) + "\n"

start = '<!-- DAILY-UPDATE:START -->'
end = '<!-- DAILY-UPDATE:END -->'
section = build_section()
new_block = f"{start}\n{section}{end}"

path = 'README.md'
with open(path, 'r', encoding='utf-8') as f:
    content = f.read()

if start in content and end in content:
    pattern = re.compile(r"<!-- DAILY-UPDATE:START -->(.|\n)*?<!-- DAILY-UPDATE:END -->", re.M)
    updated = pattern.sub(new_block, content)
else:
    updated = content.rstrip() + "\n\n" + new_block + "\n"

if updated != content:
    with open(path, 'w', encoding='utf-8') as f:
        f.write(updated)
    print('README updated')
else:
    print('No change in README')
