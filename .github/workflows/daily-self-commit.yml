name: Daily Self Commit

on:
  schedule:
    - cron: "*/5 * * * *"  # æ¯ 5 åˆ†é’Ÿä¸€æ¬¡ï¼ˆç”¨äºæµ‹è¯•ï¼‰
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: daily-self-commit
  cancel-in-progress: true

jobs:
  commit:
    # é¿å…æœºå™¨äººè‡ªå·±æ¨é€å†æ¬¡è§¦å‘å¾ªç¯
    if: ${{ !(github.event_name == 'push' && github.actor == 'github-actions[bot]') }}
    name: Commit heartbeat to main
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Configure Git author
        env:
          FALLBACK_NAME: ${{ github.repository_owner }}
          FALLBACK_EMAIL: ${{ github.repository_owner }}@users.noreply.github.com
        run: |
          set -e
          NAME="${{ secrets.COMMIT_AUTHOR_NAME }}"
          EMAIL="${{ secrets.COMMIT_AUTHOR_EMAIL }}"
          if [ -z "$NAME" ]; then
            NAME="$(git log -n 1 --pretty=format:%an || true)"
            [ -z "$NAME" ] && NAME="$FALLBACK_NAME"
          fi
          if [ -z "$EMAIL" ]; then
            EMAIL="$(git log -n 1 --pretty=format:%ae || true)"
            [ -z "$EMAIL" ] && EMAIL="$FALLBACK_EMAIL"
          fi
          echo "Using author: $NAME <$EMAIL>"
          git config user.name "$NAME"
          git config user.email "$EMAIL"

      - name: Update README with zodiac tips
        env:
          HORO_TZ: ${{ vars.HORO_TZ }}
        run: |
          set -e
          python3 - <<'PY'
import os, re, json, hashlib
from datetime import datetime, timezone
try:
    from zoneinfo import ZoneInfo
except Exception:
    ZoneInfo = None
from urllib import request, parse
SIGNS = [
    ('aries', 'ç™½ç¾Šåº§', 'â™ˆ'), ('taurus', 'é‡‘ç‰›åº§', 'â™‰'), ('gemini', 'åŒå­åº§', 'â™Š'),
    ('cancer', 'å·¨èŸ¹åº§', 'â™‹'), ('leo', 'ç‹®å­åº§', 'â™Œ'), ('virgo', 'å¤„å¥³åº§', 'â™'),
    ('libra', 'å¤©ç§¤åº§', 'â™'), ('scorpio', 'å¤©èåº§', 'â™'), ('sagittarius', 'å°„æ‰‹åº§', 'â™'),
    ('capricorn', 'æ‘©ç¾¯åº§', 'â™‘'), ('aquarius', 'æ°´ç“¶åº§', 'â™’'), ('pisces', 'åŒé±¼åº§', 'â™“')
]

TIP_BUCKET = [
    'æŠŠæ³¨æ„åŠ›æ”¾åœ¨é‡è¦çš„äººå’Œäº‹ä¸Š',
    'è¯•ç€æ—©ç¡æ—©èµ·ï¼Œæ•ˆç‡æ›´é«˜',
    'å¤§èƒ†ä¸€ç‚¹ï¼Œä¼šæœ‰æƒŠå–œå‘ç”Ÿ',
    'åˆ«æ€¥äºæ±‚æˆï¼Œç¨³æ‰ç¨³æ‰“',
    'é€‚åˆæ•´ç†æ”¶çº³ä¸å¤ç›˜æ€è€ƒ',
    'å¤šå€¾å¬ï¼Œå°‘äº‰è¾©ï¼Œäº‹åŠåŠŸå€',
    'å…‹åˆ¶æƒ…ç»ªï¼Œä¿æŒè€å¿ƒ',
    'å°è¯•åšä¸€ç‚¹è¿åŠ¨ï¼Œç„•æ–°çŠ¶æ€',
    'ä»Šæ—¥é€‚åˆå­¦ä¹ å’Œå¸æ”¶æ–°çŸ¥',
    'ç»™è‡ªå·±ä¸€ä¸ªå°ç›®æ ‡å¹¶å®Œæˆå®ƒ',
    'ä¸è€æœ‹å‹è”ç»œä¼šå¸¦æ¥å¥½è¿',
    'å°‘åˆ·æ‰‹æœºï¼Œä¸“æ³¨å½“ä¸‹',
    'ä¸»åŠ¨è¡¨è¾¾æƒ³æ³•ï¼Œæœ‰äººä¼šå“åº”',
    'é¿å…å†²åŠ¨æ¶ˆè´¹ï¼Œç†æ€§ä¸€ç‚¹',
    'æŠŠå¤æ‚é—®é¢˜æ‹†è§£æˆå°æ­¥',
    'åšä¸ªå°å°çš„å–„ä¸¾ï¼Œè¿åŠ¿+1',
    'æ¸…æ™°è¾¹ç•Œï¼Œæ‹’ç»æ— æ•ˆå†…è€—',
    'è®°å½•çµæ„Ÿï¼Œç«‹åˆ»è¡ŒåŠ¨ä¸€ä¸ª',
    'ä¿æŒå¥½å¥‡ï¼Œå‘é—®ä¸æ¢ç´¢',
    'æ‹¥æŠ±å˜åŒ–ï¼Œç›¸ä¿¡ç›´è§‰'
]

def fallback_tip(sign_en: str, date_key: str) -> str:
    s = f"{sign_en}:{date_key}".encode('utf-8')
    idx = int(hashlib.sha256(s).hexdigest(), 16) % len(TIP_BUCKET)
    return TIP_BUCKET[idx]

def fetch_tip(sign_en: str, date_key: str):
    url = f"https://aztro.sameerkumar.website/?sign={parse.quote(sign_en)}&day=today"
    try:
        req = request.Request(url, method='POST', data=b'')
        with request.urlopen(req, timeout=15) as resp:
            data = json.loads(resp.read().decode('utf-8'))
        desc = (data.get('description') or '').strip()
        if not desc:
            raise ValueError('empty description')
        # ç®€è¦åŒ–ï¼šå–ç¬¬ä¸€å¥ï¼Œè¿‡é•¿åˆ™æˆªæ–­
        tip = desc.split('.') [0].split('ã€‚')[0].strip()
        tip = (tip[:80] + 'â€¦') if len(tip) > 80 else tip
        return tip
    except Exception:
        return fallback_tip(sign_en, date_key)

def build_section():
    tz = os.getenv('HORO_TZ', '').strip() or 'Asia/Shanghai'
    tzname = tz
    try:
        z = ZoneInfo(tzname) if ZoneInfo else None
    except Exception:
        z = None
    now_dt = datetime.now(z if z else timezone.utc)
    date_str = now_dt.strftime('%Y-%m-%d')
    date_key = now_dt.strftime('%Y%m%d')

    lines = []
    lines.append(f"## ğŸ”® Daily Horoscope Tips â€¢ {date_str} ({tzname})")
    for en, zh, sym in SIGNS:
        tip = fetch_tip(en, date_key)
        lines.append(f"- {sym} {zh} {en.title()}: {tip}")
    return "\n".join(lines) + "\n"

start = '<!-- DAILY-UPDATE:START -->'
end = '<!-- DAILY-UPDATE:END -->'
section = build_section()
new_block = f"{start}\n{section}{end}"

path = 'README.md'
with open(path, 'r', encoding='utf-8') as f:
    content = f.read()

if start in content and end in content:
    pattern = re.compile(r"<!-- DAILY-UPDATE:START -->(.|\n)*?<!-- DAILY-UPDATE:END -->", re.M)
    updated = pattern.sub(new_block, content)
else:
    # append to end if markers missing
    updated = content.rstrip() + "\n\n" + new_block + "\n"

if updated != content:
    with open(path, 'w', encoding='utf-8') as f:
        f.write(updated)
    print('README updated')
else:
    print('No change in README')
PY

          git add README.md
          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          git commit -m "docs: daily horoscope tips update $(date -u '+%Y-%m-%d')"

      - name: Push changes
        if: success()
        run: |
          set -e
          git pull --rebase origin main || true
          git push origin HEAD:main
