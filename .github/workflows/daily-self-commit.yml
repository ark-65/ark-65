name: Daily Self Commit

on:
  schedule:
    - cron: "5 0 * * *"  # 每天 00:05 UTC
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: daily-self-commit
  cancel-in-progress: true

jobs:
  commit:
    # 避免机器人自己推送再次触发循环
    if: ${{ !(github.event_name == 'push' && github.actor == 'github-actions[bot]') }}
    name: Commit heartbeat to main
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Configure Git author
        env:
          FALLBACK_NAME: ${{ github.repository_owner }}
          FALLBACK_EMAIL: ${{ github.repository_owner }}@users.noreply.github.com
        run: |
          set -e
          NAME="${{ secrets.COMMIT_AUTHOR_NAME }}"
          EMAIL="${{ secrets.COMMIT_AUTHOR_EMAIL }}"
          if [ -z "$NAME" ]; then
            NAME="$(git log -n 1 --pretty=format:%an || true)"
            [ -z "$NAME" ] && NAME="$FALLBACK_NAME"
          fi
          if [ -z "$EMAIL" ]; then
            EMAIL="$(git log -n 1 --pretty=format:%ae || true)"
            [ -z "$EMAIL" ] && EMAIL="$FALLBACK_EMAIL"
          fi
          echo "Using author: $NAME <$EMAIL>"
          git config user.name "$NAME"
          git config user.email "$EMAIL"

      - name: Update README with zodiac tips
        env:
          HORO_TZ: ${{ vars.HORO_TZ }}
        run: |
          set -e
          python3 .github/scripts/update_readme_horo.py

          git add README.md
          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          git commit -m "docs: daily horoscope tips update $(date -u '+%Y-%m-%d')"

      - name: Push changes
        if: success()
        run: |
          set -e
          git pull --rebase origin main || true
          git push origin HEAD:main
